---
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly security scans
    - cron: '0 2 * * 1'
env:
  BUILD_TYPE: Debug
  CMAKE_BUILD_PARALLEL_LEVEL: 4

jobs:
  # Build and Test Job
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          ninja-build \
          llvm \
          clang \
          clang-tidy \
          clang-format \
          lcov \
          libgtest-dev \
          libgmock-dev

    - name: Configure CMake
      run: |
        cmake -S . -B build \
          -G Ninja \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -DCMAKE_CXX_FLAGS="--coverage -fprofile-instr-generate -fcoverage-mapping" \
          -DCMAKE_C_FLAGS="--coverage -fprofile-instr-generate -fcoverage-mapping" \
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}}

    - name: Run clang-tidy
      run: |
        find src include -name "*.cpp" -o -name "*.hpp" | xargs clang-tidy -p build/ --quiet
      continue-on-error: true
    
    - name: Check code formatting
      run: |
        find src include -name "*.cpp" -o -name "*.hpp" | xargs clang-format --dry-run --Werror
      continue-on-error: true

    - name: Run tests
      run: |
        cd build
        LLVM_PROFILE_FILE="coverage-%p.profraw" ctest --output-on-failure --verbose

    - name: Generate coverage report
      run: |
        cd build
        # Merge profile data
        llvm-profdata merge -sparse coverage-*.profraw -o coverage.profdata
        # Find test executables
        TEST_BINARIES=$(find . -name "*test*" -type f -perm -111 | tr '\n' ' ')
        # Generate coverage report (text)
        llvm-cov show $TEST_BINARIES -instr-profile=coverage.profdata -format=text > coverage.txt
        llvm-cov report $TEST_BINARIES -instr-profile=coverage.profdata
        # Generate HTML report
        llvm-cov show $TEST_BINARIES -instr-profile=coverage.profdata -format=html -output-dir=coverage_html
        # Generate lcov format for codecov
        llvm-cov export $TEST_BINARIES -instr-profile=coverage.profdata -format=lcov > coverage.lcov

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./build/coverage.lcov
        fail_ci_if_error: false
        verbose: true
        token: ${{ secrets.CODECOV_TOKEN }}
        exclude: "tests/**"

    - name: Upload coverage HTML report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: build/coverage_html/

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          build/
          !build/coverage_html/
          !build/*.profraw
          !build/*.profdata
          
  # Code Complexity Analysis
  code-complexity:
    name: Code Complexity Analysis
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Install Lizard and bc
      run: |
        sudo apt-get update
        sudo apt-get install -y bc
        python3 -m pip install --upgrade pip
        pip3 install lizard

    - name: Run Lizard complexity analysis
      run: |
        mkdir -p complexity-reports

        # HTML report
        echo "Generating HTML complexity report..."
        lizard src/ \
          -l cpp -V -C 15 -L 100 -a 5 -s cyclomatic_complexity \
          -x '*/build/*' -x '*/tests/*' -x '*/.git/*' -x '*/third_party/*' -x '*/external/*' \
          -H -o complexity-reports/complexity.html || true

        # XML report
        echo "Generating XML complexity report..."
        lizard src/ \
          -l cpp -V -C 15 -L 100 -a 5 -s cyclomatic_complexity \
          -x '*/build/*' -x '*/tests/*' -x '*/.git/*' -x '*/third_party/*' -x '*/external/*' \
          -X -o complexity-reports/complexity.xml || true

        # Text (full) report
        echo "Generating text complexity report..."
        lizard src/ \
          -l cpp -V -C 15 -L 100 -a 5 -s cyclomatic_complexity \
          -x '*/build/*' -x '*/tests/*' -x '*/.git/*' -x '*/third_party/*' -x '*/external/*' \
          > complexity-reports/complexity.txt || true

        # CSV report
        echo "Generating CSV complexity report..."
        lizard src/ \
          -l cpp -V -C 15 -L 100 -a 5 -s cyclomatic_complexity \
          -x '*/build/*' -x '*/tests/*' -x '*/.git/*' -x '*/third_party/*' -x '*/external/*' \
          --csv -o complexity-reports/complexity.csv || true

        echo "=== Code Complexity Summary ==="
        lizard src/ \
          -l cpp -V -C 15 -L 100 -a 5 -s cyclomatic_complexity \
          -x '*/build/*' -x '*/tests/*' -x '*/.git/*' -x '*/third_party/*' -x '*/external/*' || true
        echo "=== End Code Complexity Summary ==="

    - name: Generate complexity badge
      run: |
        # Extract Avg CCN from the summary table
        AVG_COMPLEXITY=$(
          lizard src/ \
            -l cpp -C 15 -L 100 -a 5 -s cyclomatic_complexity \
            -x '*/build/*' -x '*/tests/*' -x '*/.git/*' -x '*/third_party/*' -x '*/external/*' \
          | tail -n 1 | tr -s " " | sed 's/ /,/g' | cut -d, -f4
        )

        mkdir -p complexity-reports/badges

        if [[ $(echo "$AVG_COMPLEXITY > 10" | bc -l) -eq 1 ]]; then
          COLOR="red"
        elif [[ $(echo "$AVG_COMPLEXITY > 5" | bc -l) -eq 1 ]]; then
          COLOR="yellow"
        else
          COLOR="green"
        fi

        cat > complexity-reports/badges/complexity.json << EOF
        {
          "schemaVersion": 1,
          "label": "complexity",
          "message": "${AVG_COMPLEXITY}",
          "color": "${COLOR}"
        }
        EOF
        echo "Generated complexity badge with average CCN: $AVG_COMPLEXITY"

    - name: Upload complexity reports
      uses: actions/upload-artifact@v4
      with:
        name: complexity-reports
        path: complexity-reports/

    - name: Check complexity thresholds
      run: |
        MAX_COMPLEXITY=15
        MAX_LINES=100
        echo "Checking for functions exceeding complexity thresholds..."
        if lizard src/ -l cpp -w -C $MAX_COMPLEXITY -L $MAX_LINES \
             -x '*/build/*' -x '*/tests/*' -x '*/.git/*' -x '*/third_party/*' -x '*/external/*' \
           | grep -q "!!"; then
          echo "‚ö†Ô∏è Warning: Some functions exceed complexity thresholds"
          lizard src/ -l cpp -w -C $MAX_COMPLEXITY -L $MAX_LINES \
            -x '*/build/*' -x '*/tests/*' -x '*/.git/*' -x '*/third_party/*' -x '*/external/*' || echo oops > /dev/null
          echo "Consider refactoring complex functions for better maintainability"
        else
          echo "‚úÖ All functions are within acceptable complexity limits"
        fi
      continue-on-error: true

  semgrep:
    name: semgrep/ci
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
    container:
      image: semgrep/semgrep
    steps:
      - uses: actions/checkout@v4
      - run: semgrep ci

  # CodeQL Analysis
  codeql:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: [ 'cpp' ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          config-file: ./.github/codeql/codeql-config.yml

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build libgtest-dev libgmock-dev

      - name: Build for CodeQL
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
          cmake --build build

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"

  # Dependency Vulnerability Scan
  dependency-scan:
    runs-on: ubuntu-latest
    name: Dependency Vulnerability Scan
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif

  # Release Job (only on tags)
  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build-and-test, code-complexity, semgrep, codeql]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build libgtest-dev libgmock-dev
      - name: Build Release
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
          cmake --build build
          cmake --build build --target package
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/*.tar.gz
            build/*.deb
            build/*.rpm
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Documentation Job
  docs:
    name: Generate Documentation
    runs-on: ubuntu-latest
    needs: [build-and-test, code-complexity]
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Doxygen and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz python3-pip
          pip3 install lizard

      - name: Download complexity reports
        uses: actions/download-artifact@v4
        with:
          name: complexity-reports
          path: complexity-reports/

      - name: Generate Doxygen documentation
        run: |
          # Generate Doxygen documentation
          doxygen Doxyfile || echo "No Doxyfile found, creating basic documentation structure"

          # Create docs directory if it doesn't exist
          mkdir -p docs/html

      - name: Create comprehensive documentation site
        run: |
          # Create main documentation directory structure
          mkdir -p docs/html/complexity
          mkdir -p docs/html/reports
          mkdir -p docs/html/badges

          # Copy complexity reports to documentation
          cp -r complexity-reports/* docs/html/complexity/ || echo "No complexity reports found"

          # Create an index page that includes links to all reports
          cat > docs/html/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>OTTR Project Documentation</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                  .header { background: #f4f4f4; padding: 20px; border-radius: 5px; margin-bottom: 30px; }
                  .badges { margin: 15px 0; }
                  .badges img { margin-right: 10px; }
                  .section { margin: 20px 0; padding: 15px; border-left: 4px solid #007acc; }
                  .reports-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
                  .report-card { background: #f9f9f9; padding: 20px; border-radius: 8px; border: 1px solid #ddd; }
                  .report-card h3 { margin-top: 0; color: #333; }
                  .report-card a { color: #007acc; text-decoration: none; font-weight: bold; }
                  .report-card a:hover { text-decoration: underline; }
                  .report-card p { color: #666; margin: 10px 0; }
                  .metrics { background: #e8f4f8; padding: 15px; border-radius: 5px; margin: 15px 0; }
                  .metrics h4 { margin-top: 0; color: #2c5aa0; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>OTTR Project Documentation</h1>
                  <p>Comprehensive documentation and analysis reports for the OTTR project</p>
                  <div class="badges">
                      <img src="https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/ruxven/ottr/gh-pages/complexity/badges/complexity.json" alt="Code Complexity">
                      <img src="https://img.shields.io/github/workflow/status/ruxven/ottr/CI%2FCD%20Pipeline" alt="Build Status">
                  </div>
              </div>

              <div class="section">
                  <h2>üìö API Documentation</h2>
                  <p>Detailed code documentation generated from source comments</p>
                  <a href="./annotated.html">Browse API Documentation ‚Üí</a>
              </div>

              <div class="section">
                  <h2>üìä Code Analysis Reports</h2>
                  <div class="reports-grid">
                      <div class="report-card">
                          <h3>üîç Code Complexity Analysis</h3>
                          <p>Cyclomatic complexity analysis of functions and methods</p>
                          <div class="metrics">
                              <h4>Quick Metrics</h4>
                              <p>View the summary report for key complexity statistics and trends.</p>
                          </div>
                          <a href="./complexity/complexity.html">View HTML Report ‚Üí</a><br>
                          <a href="./complexity/summary.txt">View Summary ‚Üí</a><br>
                          <a href="./complexity/complexity.txt">View Detailed Text Report ‚Üí</a><br>
                          <a href="./complexity/complexity.csv">Download CSV Data ‚Üí</a>
                      </div>

                      <div class="report-card">
                          <h3>üìà Code Metrics</h3>
                          <p>Lines of code, function counts, and maintainability metrics</p>
                          <a href="./complexity/complexity.xml">View XML Report ‚Üí</a>
                      </div>
                  </div>
              </div>

              <div class="section">
                  <h2>üîó Quick Links</h2>
                  <ul>
                      <li><a href="./files.html">File List</a> - Browse all documented files</li>
                      <li><a href="./classes.html">Class Index</a> - All classes and structures</li>
                      <li><a href="./functions.html">Function Index</a> - All functions and methods</li>
                      <li><a href="./globals.html">Global Symbols</a> - Global variables and definitions</li>
                  </ul>
              </div>

              <div class="section">
                  <h2>‚ÑπÔ∏è About</h2>
                  <p>This documentation is automatically generated from the source code and updated with each commit to the main branch.</p>
                  <p>Code complexity analysis is performed using <a href="https://github.com/terryyin/lizard">Lizard</a> to help maintain code quality.</p>
                  <p>Last updated: <span id="timestamp"></span></p>
                  <script>
                      document.getElementById('timestamp').textContent = new Date().toLocaleString();
                  </script>
              </div>
          </body>
          </html>
          EOF

          # Create an index page that includes links to all reports
          cat > docs/html/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>OTTR Project Documentation</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                  .header { background: #f4f4f4; padding: 20px; border-radius: 5px; margin-bottom: 30px; }
                  .section { margin: 20px 0; padding: 15px; border-left: 4px solid #007acc; }
                  .reports-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
                  .report-card { background: #f9f9f9; padding: 20px; border-radius: 8px; border: 1px solid #ddd; }
                  .report-card h3 { margin-top: 0; color: #333; }
                  .report-card a { color: #007acc; text-decoration: none; font-weight: bold; }
                  .report-card a:hover { text-decoration: underline; }
                  .report-card p { color: #666; margin: 10px 0; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>OTTR Project Documentation</h1>
                  <p>Comprehensive documentation and analysis reports for the OTTR project</p>
              </div>

              <div class="section">
                  <h2>üìö API Documentation</h2>
                  <p>Detailed code documentation generated from source comments</p>
                  <a href="./annotated.html">Browse API Documentation ‚Üí</a>
              </div>

              <div class="section">
                  <h2>üìä Code Analysis Reports</h2>
                  <div class="reports-grid">
                      <div class="report-card">
                          <h3>üîç Code Complexity Analysis</h3>
                          <p>Cyclomatic complexity analysis of functions and methods</p>
                          <a href="./complexity/complexity.html">View HTML Report ‚Üí</a><br>
                          <a href="./complexity/complexity.txt">View Text Report ‚Üí</a><br>
                          <a href="./complexity/complexity.csv">Download CSV Data ‚Üí</a>
                      </div>

                      <div class="report-card">
                          <h3>üìà Code Metrics</h3>
                          <p>Lines of code, function counts, and maintainability metrics</p>
                          <a href="./complexity/complexity.xml">View XML Report ‚Üí</a>
                      </div>
                  </div>
              </div>

              <div class="section">
                  <h2>üîó Quick Links</h2>
                  <ul>
                      <li><a href="./files.html">File List</a> - Browse all documented files</li>
                      <li><a href="./classes.html">Class Index</a> - All classes and structures</li>
                      <li><a href="./functions.html">Function Index</a> - All functions and methods</li>
                      <li><a href="./globals.html">Global Symbols</a> - Global variables and definitions</li>
                  </ul>
              </div>

              <div class="section">
                  <h2>‚ÑπÔ∏è About</h2>
                  <p>This documentation is automatically generated from the source code and updated with each commit to the main branch.</p>
                  <p>Last updated: <span id="timestamp"></span></p>
                  <script>
                      document.getElementById('timestamp').textContent = new Date().toLocaleString();
                  </script>
              </div>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/html
